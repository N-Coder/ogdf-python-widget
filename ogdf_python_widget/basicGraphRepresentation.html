<!DOCTYPE html>
<meta charset="utf-8">
<svg id="placeholderId" width="960" height="540"></svg>
<script>

    require.config({paths: {d3: "https://d3js.org/d3.v7.min"}});

    require(["d3"], function (d3) {
        var svg = d3.select("#placeholderId"),
            width = +svg.attr("width"),
            height = +svg.attr("height");

        var radius = 15;
        var forceDirected = true;
        var color = forceDirected ? "black" : "green"

        //construct arrow
        svg.append("svg:defs").selectAll("marker")
            .data(["end"])
            .enter().append("svg:marker")
            .attr("id", String)
            .attr("viewBox", "0 -5 10 10")
            .attr("refX", 21)
            .attr("refY", 0)
            .attr("markerWidth", 6)
            .attr("markerHeight", 6)
            .attr("orient", "auto")
            .attr("fill", "black")
            .append("svg:path")
            .attr("d", "M0,-5L10,0L0,5");

        svg.append("svg:defs").selectAll("marker")
            .data(["endGA"])
            .enter().append("svg:marker")
            .attr("id", String)
            .attr("viewBox", "0 -5 10 10")
            .attr("refX", 21)
            .attr("refY", 0)
            .attr("markerWidth", 6)
            .attr("markerHeight", 6)
            .attr("orient", "auto")
            .attr("fill", "green")
            .append("svg:path")
            .attr("d", "M0,-5L10,0L0,5");

        //data will get filled from the python code
        var nodes_data = []
        var links_data = []

        //set up the simulation and add forces
        if (forceDirected) {

            var simulation = d3.forceSimulation().nodes(nodes_data);

            var link_force = d3.forceLink(links_data).id(function (d) {
                return d.name;
            });

            var charge_force = d3.forceManyBody().strength(-100);

            var center_force = d3.forceCenter(width / 2, height / 2);

            simulation
                .force("charge_force", charge_force)
                .force("center_force", center_force)
                .force("links", link_force);

            //add tick instructions:
            simulation.on("tick", tickActions);
        }

        //add encompassing group for the zoom
        var g = svg.append("g").attr("class", "everything");

        //draw lines for the links
        var link = g.append("g")
            .attr("class", "links")
            .selectAll("line")
            .data(links_data)
            .enter()
            .append("line")
            .attr("marker-end", function (d) {
                if (forceDirected)
                    return "url(#end)"
                if (forceDirected || d.arrow) {
                    return "url(#endGA)";
                } else {
                    return null;
                }
            })
            .attr("stroke-width", 2)
            .style("stroke", color)
            .attr("x1", function (d) {
                if (d.sx == null) return
                return d.sx
            })
            .attr("y1", function (d) {
                if (d.sy == null) return
                return d.sy
            })
            .attr("x2", function (d) {
                if (d.tx == null) return
                return d.tx
            })
            .attr("y2", function (d) {
                if (d.ty == null) return
                return d.ty
            });

        //draw circles for the nodes
        var node = g.append("g")
            .attr("class", "nodes")
            .selectAll("circle")
            .data(nodes_data)
            .enter()
            .append("circle")
            .attr("r", radius)
            .attr("fill", color)
            .attr("cx", function (d) {
                if (d.x == null) return
                return d.x
            })
            .attr("cy", function (d) {
                if (d.y == null) return
                return d.y
            });

        var text = g.append("g")
            .attr("class", "texts")
            .selectAll("text")
            .data(nodes_data)
            .enter()
            .append("text")
            .attr("fill", "white")
            .attr("text-anchor", "middle")
            .attr("dominant-baseline", "central")
            .text(function (d) {
                return d.name;
            })
            .attr("transform", function (d) { //<-- use transform it's not a g
                if (d.x == null || d.y == null) return
                return "translate(" + d.x + "," + d.y + ")";
            });

        //add drag capabilities
        if (forceDirected) {
            var drag_handler = d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended);

            node.call(drag_handler)
            text.call(drag_handler)
        }

        //Drag functions
        function dragstarted(event) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            event.subject.fx = event.subject.x;
            event.subject.fy = event.subject.y;
        }

        function dragged(event) {
            event.subject.fx = event.x;
            event.subject.fy = event.y;
        }

        function dragended(event) {
            if (!event.active) simulation.alphaTarget(0);
            event.subject.fx = null;
            event.subject.fy = null;
        }

        function tickActions() {
            //update circle positions each tick of the simulation
            node
                .attr("cx", function (d) {
                    return d.x;
                })
                .attr("cy", function (d) {
                    return d.y;
                });

            //update link positions
            link
                .attr("x1", function (d) {
                    return d.source.x;
                })
                .attr("y1", function (d) {
                    return d.source.y;
                })
                .attr("x2", function (d) {
                    return d.target.x;
                })
                .attr("y2", function (d) {
                    return d.target.y;
                });

            //update text positions
            text
                .attr("transform", function (d) { //<-- use transform it's not a g
                    return "translate(" + d.x + "," + d.y + ")";
                });
        }

        //add zoom capabilities
        svg.call(d3.zoom()
            .extent([[0, 0], [width, height]])
            .on("zoom", zoomed));

        function zoomed({transform}) {
            g.attr("transform", transform);
        }
    })
    ;
</script>